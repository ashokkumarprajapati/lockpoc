
 <link rel='stylesheet' href='css/visualsearch.css'>
 <link rel='stylesheet' href='css/visualsearch-datauri.css'>
 <div class="container-fluid"  id="VS">
 <!--
    <p><span class="demo-hint">
    <i>Valid Facets: <b>role</b>,<b>skill</b> or <b>location</b> and free text.</i></span>
    </p>
  -->
   <div id="search_box_container"></div>
    <div class="row-fluid">
      <div id=search-results>
      </div> <!--/search-results-->
    </div><!--/row-->
</div> <!-- /container -->

<script src="/js/dependencies.js"></script>
<script src="/js/visualsearch.js"></script>
<script type="text/javascript" charset="utf-8">

      $(document).ready(function() {

        function do_search(facets) {
          	var query = "";
			var data = "{";
			  var counter = 1;
			  for (var i in facets) {
			      var innerObj = facets[i];
			      for(var key in innerObj){
			        data += "\"" + key + "\":\"" + innerObj[key] + "\"";
			        //
			        if (key=="text") {
			          query += "_all:" + innerObj[key].toLowerCase() + " ";
			        } 
			        else if (key=="role")
			        {
			           query +=  "linkedin.positions.values.title:" + innerObj[key].toLowerCase() + " " +
				   	    "sap['Position Name']:" + innerObj[key].toLowerCase() + " ";
			        }
			        else if (key=="country") {
			            query = query + "linkedin.location.name:" + innerObj[key].toLowerCase() + " " + 
						"sap.Location:" + innerObj[key].toLowerCase() + " ";
			        }
			        else if (key=="skill") {
			            query = query + "linkedin.skills.values.skill.name:" + innerObj[key].toLowerCase() + " ";
			        }

			      }   
			    if (counter < facets.length) {
			      data += ",";
			    }
			    counter++;
			  } 
			  data += "}";

  //console.log("data");
  //console.log(data);

  
          qdata = JSON.stringify({
              "fields": ["_source.linkedin.headline", "_source.linkedin.firstName", "_source.linkedin.lastName",
                "_source.linkedin.pictureUrl", "_source.linkedin.location.name"],
                "query": {
                  "query_string": {"query": query
                }
              }
            });

 //         console.log("qdata");
 //         console.log(qdata);

          $.ajax({
            url: 'http://lockbox.egi.ericsson.com:9200/lockpoc/profiles/_search?analyzer=auto_complete&pretty=true',
            type: 'POST',
            data: qdata,
            dataType: 'json',
            processData: false,
            success: function (data, statusText, xhr) {

              var hits = data.hits.hits;
              var htmlContent = "";
              for (var i in hits) {
                var profileUrl = 'http://statsdsxs.egi.ericsson.com:8084/#/' + hits[i]._id;
                var fields = hits[i].fields;
                if (fields) {
			if (!fields["_source.linkedin"]){
				name = fields["_source.sap.Name"].value;
				image = "dummy";
				headline = fields["_source.sap.Position Name"].value;
				loc = fields["_source.sap.location"];
			}
	                if (fields["_source.linkedin.pictureUrl"])
	                	image = fields["_source.linkedin.pictureUrl"].value;
	                else
	                 	image = "dummy";
	               	
	                if (fields["_source.linkedin.firstName"].value)
	                	name = fields["_source.linkedin.firstName"].value;
	                else
	                	name = "";

	                if (fields["_source.linkedin.lastName"].value)
	                	name += " " + fields["_source.linkedin.lastName"].value;

	                if (fields["_source.linkedin.headline"])
	                	headline = fields["_source.linkedin.headline"].value;
	                else
	                	headline="";

	                if (fields["_source.linkedin.location.name"])
	                	loc = fields["_source.linkedin.location.name"];
	                else
	                	loc="";

	                  htmlContent += '<div class="thumbnail span4">' +
	                  '<a href="' + profileUrl + '" target="_top" >' +
	                  '<img src="' + image + '"  width="60" height="60">' +
	                  '</a> <h2>' +
	                  '<a href="' + profileUrl + '" class="" title="View Profile" target="_top">' + name + 
                    '</a></h2> <h3> Title ' + headline + '</h3>' +
	                  'Location' + loc + '</span>' +'</div>';
	              }
              }

              $('div#search-results')
                .html(htmlContent);
            },
            error: function (xhr, message, error) {
              console.error("Error in search", message);
              $('div#search-results').html(message);
              throw(error);
           }});
          }        

       window.visualSearch = VS.init({
          container  : $('#search_box_container'),
          query      : '',
          unquotable : [
            'text',
            'filter'
          ],
          callbacks  : {
            search : function(query, searchCollection) {
 
              if ( searchCollection.facets() != '') {
                  do_search(searchCollection.facets());
                  //$query.stop().animate({opacity : 1}, {duration: 300, queue: false});
                  //$query.html('<span class="raquo">&raquo;</span> You searched for: <b>' + searchCollection.serialize() + '</b>'); 
              } else {
                $('div#search-results').html('');
              }        

            },
            valueMatches : function(category, searchTerm, callback) {
              switch (category) {
                 case 'name':               
                  break;
                case 'role':
                    $.ajax({   url: 'http://lockbox.egi.ericsson.com:9200/lockpoc/profiles/_search?pretty=true'
                        , type: 'POST'
                        , data : JSON.stringify({
                  			"query" : { "match_all" : {  } },
                  			"fields" : [],
                  			"facets" : { "roles" : { "terms" : { "fields" :  ["linkedin.positions.values.title.untouched",
							"sap['Position Name']", "size"  : "10" } } } })
                        , dataType : 'json'
                        , processData: false
                        , success: function(data, statusText, xhr) {
                          var roles = [];
                          for (var i in data.facets.roles.terms) {
                            roles.push(data.facets.roles.terms[i].term);
                          }                         
                            callback(roles, {preserveOrder: true});
                          }
                        , error: function(xhr, message, error) {
                              console.error("Error while loading data from ElasticSearch", message);
            				  $('div#search-results').html(error);
                              throw(error);
                          }
                  });
                  break;
                case 'tag':                 
                  break;
                case 'skill':
                    $.ajax({   url: 'http://lockbox.egi.ericsson.com:9200/lockpoc/profiles/_search?pretty=true'
                        , type: 'POST'
                        , data : JSON.stringify({
                  			"query" : { "match_all" : {  } },
                  			"fields" : [],
                  			"facets" : { "skills" : { "terms" : { "field" : "linkedin.skills.values.skill.name.untouched",
                      		"size"  : "10" } } } })
                        , dataType : 'json'
                        , processData: false
                        , success: function(data, statusText, xhr) {
                          var skills = [];
                          for (var i in data.facets.skills.terms) {
                            skills.push(data.facets.skills.terms[i].term);
                          }                         
                            callback(skills, {preserveOrder: true});
                          }
                        , error: function(xhr, message, error) {
                              console.error("Error while loading data from ElasticSearch", message);
                              $('div#search-results').html(error);
                                throw(error);
                          }
                  });
                  break;
                case 'title':
                  
                  break;
                case 'country':
                    $.ajax({   url: 'http://lockbox.egi.ericsson.com:9200/lockpoc/profiles/_search?pretty=true'
                        , type: 'POST'
                        , data : JSON.stringify({
                  			"query" : { "match_all" : {  } },
                  			"fields" : [],
                  			"facets" : { "location" : { "terms" : { "field" : "sap.Location",
   						"size"  : "10" } } } })
                        , dataType : 'json'
                        , processData: false
                        , success: function(data, statusText, xhr) {
                          var country = [];
                          for (var i in data.facets.location.terms) {
                            country.push(data.facets.location.terms[i].term);
                          }                         
                            callback(country, {preserveOrder: true});
                          }
                        , error: function(xhr, message, error) {
                              console.error("Error while loading data from ElasticSearch", message);
                              $('div#search-results').html(error);
                              throw(error);
                          }
                  });
                  break;
              }
            },
            facetMatches : function(callback) {
              callback([
                'skill',  'role', 'country'
              ]);
            }
          }
        });
      });
    </script>

